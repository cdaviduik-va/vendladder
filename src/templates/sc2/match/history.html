{% extends "sc2/global.html" %}

{% block controls %}
    {% if is_admin %}
        <a class="btn btn-primary" href="{{ uri_for('sc2-admin-match-create') }}">Create Match</a>
    {% endif %}
{% endblock %}

{% block content %}

    <h2>Current Matches</h2>

    <div class="well">
        If your match doesn't appear here <a href="{{ uri_for('sc2-game-submit') }}">upload a replay</a> to create it.
    </div>

    {% if current_matches %}
        <table class="table">
            <thead>
                <tr>
                    <th>Team 1</th>
                    <th>Team 2</th>
                    <th>Replay</th>
                    <th>Close</th>
                </tr>
            </thead>
            <tbody>
                {% for match in current_matches %}
                    <tr>
                        <td>{{ match.team1_battle_net_names|join(', ') }}</td>
                        <td>{{ match.team2_battle_net_names|join(', ') }}</td>
                        <td><a class="btn btn-primary" href="{{ uri_for('sc2-game-submit', match_id=match.match_id) }}">Upload Replay</a></td>
                        <td><a class="btn btn-danger close-match" href="{{ uri_for('sc2-match-close', match_id=match.match_id) }}">Close Match</a></td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <div class="well">
            There are currently no matches taking place.
        </div>
    {% endif %}

<h2>Game History</h2>
<table class="table">
    <thead>
        <tr>
            <th>Winning Team</th>
            <th>Losing Team</th>
            <th>Map</th>
            <th>Date</th>
            <th>Replay</th>
        </tr>
    </thead>
    <tbody data-bind="foreach: games">
        <tr>
            <td data-bind="text:winningTeam"></td>
            <td data-bind="text:losingTeam"></td>
            <td data-bind="text:map_name"></td>
            <td data-bind="text:game_time"></td>
            <td><a data-bind="attr:{href:download_replay_link}">Download</a></td>
        </tr>
    </tbody>
</table>

{% endblock %}

{% block script %}
<script type="text/javascript" language="javascript">
    var games = {{games | safe}};
    var viewModel = null;

    $('.close-match').click(function() {
        var $this = $(this);
        var url = $this.attr('href');
        $.post(url, function() {
            var $parent = $this.closest('tr').slideUp(function() {
                $parent.remove();
            });
        });
        return false;
    });

    function PlayerPerformanceModel(data) {
        var self = this;

        self.battle_net_name = ko.observable(data.battle_net_name);
        self.won = ko.observable(data.won);
    }

    function GameModel(data) {
        var self = this;

        self.game_id = ko.observable(data.game_id);
        self.map_name = ko.observable(data.map_name);
        self.game_time = ko.observable(data.game_time);
        self.playerPerformances = ko.observableArray();

        self.winningTeam = ko.computed(function() {
            var winningPlayers = [];
            var perfs = self.playerPerformances();
            for(var i=0; i<perfs.length; i++) {
                if(perfs[i].won()) {
                    winningPlayers.push(perfs[i].battle_net_name());
                }
            }
            return winningPlayers.join(', ');
        });

        self.losingTeam = ko.computed(function() {
            var losingPlayers = [];
            var perfs = self.playerPerformances();
            for(var i=0; i<perfs.length; i++) {
                if(!perfs[i].won()) {
                    losingPlayers.push(perfs[i].battle_net_name());
                }
            }
            return losingPlayers.join(', ');
        });

        self.download_replay_link = ko.computed(function() {
            return "/sc2/game/download/?id=" + self.game_id();
        });

        //Initialization
        for(var i=0; i<data.players.length; i++) {
            var playerPerformance = new PlayerPerformanceModel(data.players[i]);
            self.playerPerformances.push(playerPerformance);
        }
    }

    function GamesListViewModel(gamesData) {
        var self = this;

        self.games = ko.observableArray();

        //Initialization
        for(var i=0; i<gamesData.length; i++) {
            var game = new GameModel(gamesData[i]);
            self.games.push(game);
        }
    }

    $(function() {
        //Initial setup
        viewModel = new GamesListViewModel(games);
        ko.applyBindings(viewModel);
    });
</script>
{% endblock %}